[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:postgresql]
command=postgres -D /var/lib/postgresql/data
user=postgres
autostart=true
autorestart=true
priority=1
stdout_logfile=/var/log/postgresql/postgresql.stdout.log
stderr_logfile=/var/log/postgresql/postgresql.stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/postgresql15/bin"

[program:init-database]
command=/usr/local/bin/init-database.sh
user=postgres
autostart=true
autorestart=false
startsecs=0
priority=2
stdout_logfile=/var/log/supervisor/init-database.log
stderr_logfile=/var/log/supervisor/init-database.log
environment=PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/postgresql15/bin"

[program:redis]
command=/usr/bin/redis-server --bind 0.0.0.0 --port 6379 --maxmemory 2gb --maxmemory-policy allkeys-lru --appendonly yes --dir /var/lib/redis
user=redis
directory=/var/lib/redis
autostart=true
autorestart=true
priority=3
stdout_logfile=/var/log/redis/redis.stdout.log
stderr_logfile=/var/log/redis/redis.stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

[program:backend]
command=/app/main
autostart=true
autorestart=true
priority=4
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    DATABASE_URL="postgresql://postgres:postgres@localhost:5432/workspaces?sslmode=disable",
    REDIS_URL="redis://localhost:6379/0",
    PORT="8080",
    ENVIRONMENT="development"

# Wait for database initialization to complete
startsecs=10

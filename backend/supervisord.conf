[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:postgresql]
command=postgres -D /var/lib/postgresql/data
user=postgres
autostart=true
autorestart=true
priority=1
stdout_logfile=/var/log/postgresql/postgresql.stdout.log
stderr_logfile=/var/log/postgresql/postgresql.stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=PATH="/usr/local/bin:/usr/bin:/bin:/usr/lib/postgresql15/bin"

[program:redis]
command=/usr/bin/redis-server --bind 127.0.0.1 --port 6379 --maxmemory 2gb --maxmemory-policy allkeys-lru --appendonly yes --dir /var/lib/redis
user=redis
directory=/var/lib/redis
autostart=true
autorestart=true
priority=2
stdout_logfile=/var/log/redis/redis.stdout.log
stderr_logfile=/var/log/redis/redis.stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

[program:backend]
command=/app/main
autostart=true
autorestart=true
priority=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=
    DATABASE_URL="%(ENV_DATABASE_URL)s",
    REDIS_URL="%(ENV_REDIS_URL)s",
    PORT="%(ENV_PORT)s",
    ENVIRONMENT="%(ENV_ENVIRONMENT)s",
    JWT_SECRET="%(ENV_JWT_SECRET)s",
    AWS_REGION="%(ENV_AWS_REGION)s",
    AWS_ACCESS_KEY_ID="%(ENV_AWS_ACCESS_KEY_ID)s",
    AWS_SECRET_ACCESS_KEY="%(ENV_AWS_SECRET_ACCESS_KEY)s",
    AI_SERVICE_URL="%(ENV_AI_SERVICE_URL)s"

# Wait for PostgreSQL and Redis to start
startsecs=5
